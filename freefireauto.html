<!DOCTYPE html>
<html dir="rtl" lang="ar">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>قصي ستور - فري فاير (تلقائي)</title>
  <link rel="icon" href="emp.png" type="image/png">

  <!-- منع الدخول المباشر: يعيد إلى الرئيسية إن لم تكن الملاحة من الداخل -->
  <script>
    (function(){
      try{
        var nav = (performance.getEntriesByType && performance.getEntriesByType('navigation')) || [];
        var type = nav[0] ? nav[0].type : (performance.navigation ? (performance.navigation.type === 1 ? 'reload' : (performance.navigation.type === 2 ? 'back_forward' : '')) : '');
        var isReload = type === 'reload';
        var isBF = type === 'back_forward';
        var ok = sessionStorage.getItem('nav:fromHome') === '1';
        if (!ok && !isReload && !isBF) {
          sessionStorage.setItem('nav:redirectedFrom', location.pathname.split('/').pop());
          window.location.replace('index.html');
        } else if (ok) {
          sessionStorage.removeItem('nav:fromHome');
        }
      }catch(e){ /* في حال الفشل الصريح نعيد للتأكد */ window.location.replace('index.html'); }
    })();
  </script>

  <!-- تهيئة الثيم مبكرًا لتجنب وميض اللون -->
  <script>
    (function () {
      var theme = 'dark';
      try {
        var t = localStorage.getItem('theme');
        if (!t) t = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
        theme = (t === 'light') ? 'light' : 'dark';
      } catch (e) { theme = 'dark'; }
      document.documentElement.setAttribute('data-theme', theme);
      try {
        var metaCS = document.querySelector('meta[name="color-scheme"]');
        if (!metaCS) { metaCS = document.createElement('meta'); metaCS.name = 'color-scheme'; document.head.appendChild(metaCS); }
        metaCS.setAttribute('content', theme === 'dark' ? 'dark light' : 'light dark');
        var metaTC = document.querySelector('meta[name="theme-color"]');
        if (!metaTC) { metaTC = document.createElement('meta'); metaTC.name = 'theme-color'; document.head.appendChild(metaTC); }
        metaTC.setAttribute('content', theme === 'dark' ? '#0b1220' : '#f9f9f9');
      } catch(e){}
      var s = document.createElement('style');
      s.id = 'critical-theme';
      s.textContent = 'html{background:'+(theme==='dark'?'#0b1220':'#f9f9f9')+';color:'+(theme==='dark'?'#e6edf3':'#333')+'} body{background:inherit;color:inherit;margin:0}';
      document.head.appendChild(s);
    })();
  </script>
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0b1220">

  <!-- تحسين الاتصال المسبق -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://i.ibb.co" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- تحميل مسبق لصورة العروض المتكررة -->
  <link rel="preload" as="image" href="https://i.ibb.co/m5HLhf1n/1756802404151-1.jpg">

  <!-- Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <!-- الخطوط والأيقونات -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <!-- لوتي (غير حاجز) -->
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js" async></script>

  <!-- CSS -->
  <link href="style1.css" rel="stylesheet"/>
  <link href="header.css" rel="stylesheet"/>

  <!-- Firebase SDKs (كما كان في الأعلى قبل الهيدر) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Scripts: ابدأ بتهيئة Firebase ثم بقية السكربتات -->
  <script src="script1auto.js"></script>
  <script defer src="header.js"></script>
  <script defer src="scriptauto.js"></script>
  <script defer src="atff.js"></script>

  <!-- لودر الصفحة -->
  <link rel="stylesheet" href="loader.css">
  <script src="loader.js" defer></script>

  <!-- أصوات (بدون تحميل مسبق ثقيل) -->
  <audio id="toast-success-sound" preload="none" src="success.mp3"></audio>
  <audio id="toast-error-sound" preload="none" src="error.mp3"></audio>

  <style>
    /* اتجاه عام مساعد */
    .rtl { direction: rtl; text-align: right; unicode-bidi: embed; }


    /* صندوق الملخص */
    #selected-amount-container {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      text-align: center !important;
      margin:20px auto;max-width:400px;padding:20px;
      border:2px solid #007bff;border-radius:10px;background:#f9f9f9;font-weight:bold;
    }
    #selected-amount-container h2 { margin-bottom: 10px !important; }

    /* ✅ القسيمة RTL مع عزل الإنجليزية */
    #selected-amount-container .voucher{
      display:block !important;
      margin:0 auto !important;
      direction: rtl;
      text-align: right;
      unicode-bidi: isolate;
      font-weight: 700;
    }
    .voucher .line{ direction: rtl; text-align: right; margin: 10px 0; }
    .voucher .ltr{ direction: ltr; unicode-bidi: isolate; display:inline-block; white-space: nowrap; }
    .voucher .sep{ unicode-bidi: isolate; display:inline-block; padding: 0 .15rem; }
    .voucher .price{ white-space: nowrap; }

    /* البطاقات + تغطية "غير متوفر" */
    .offer-box { position: relative; cursor: pointer; }
    .offer-box.disabled { opacity: .4; cursor: not-allowed; }
    .offer-box .unavailable-badge{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); color:#fff; font-weight:700; border-radius:12px;
    }

/* ====== Dark Mode for Free Fire page ====== */
body.dark-mode{ background:#0b1220; color:#e6edf3; }

/* الصندوق الرئيسي */
body.dark-mode .main-white-box{
  background:#0f172a !important;
  color:#e6edf3 !important;
  border:1px solid #334155 !important;
  box-shadow:0 8px 22px rgba(0,0,0,.35);
}

/* صندوق مُعرّف اللاعب */
body.dark-mode .player-id-box{
  background:#0f172a !important;
  border-color:#334155 !important;
  color:#e6edf3 !important;
}
body.dark-mode .player-id-box label{ color:#e6edf3 !important; }
body.dark-mode .player-id-box input{
  background:#0b1220 !important;
  color:#e6edf3 !important;
  border-color:#334155 !important;
}

/* صندوق المبلغ المختار */
body.dark-mode #selected-amount-container{
  background:#0f172a !important;
  border-color:#334155 !important;
  color:#ffffff !important;
}
body.dark-mode #selected-amount-container .voucher,
body.dark-mode #selected-amount-container .voucher .line,
body.dark-mode #selected-amount-container .voucher .price{
  color:#ffffff !important;
}

/* بطاقات العروض */
body.dark-mode .offer-box{
  background:#101826 !important;
  border:1px solid #334155 !important;
  color:#e6edf3 !important;
}
body.dark-mode .offer-box span{ color:#e6edf3 !important; }
body.dark-mode .offer-box.selected{ outline:2px solid #38bdf8; }
body.dark-mode .offer-box.disabled .unavailable-badge{ background:rgba(0,0,0,.45); }

/* عناوين الأقسام */
body.dark-mode .section-title{ color:#7dd3fc !important; }

/* زر الشراء */
body.dark-mode .send-button{
  background:#0369a1 !important;
  color:#e6edf3 !important;
}
body.dark-mode .send-button:hover{ background:#0ea5e9 !important; }

/* التوست */
body.dark-mode #toast{
  background:#0f172a !important;
  color:#e6edf3 !important;
}

/* النافذة المنبثقة (دليل المعرف) */
body.dark-mode #popup > div{
  background:#111827 !important;
  color:#e6edf3 !important;
}

/* محاكاة شيمر أخفت في الوضع الداكن إن وُجد */
body.dark-mode .offer-box.loading{ background:#162032 !important; }

/* === اجعل خلفية قسم لماذا تختارنا مثل الخلفيات الأخرى === */

/* وضع فاتح: لون مسطح مطابق لصناديق الصفحة */
.footer-icons{
  background: #f9f9f9 !important;  /* بديل للتدرّج */
  border: 1px solid #e0e6f7;        /* نفس حدود الصناديق الفاتحة */
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

/* تباين عنوان القسم على الخلفية الفاتحة */
.footer-title{
  color: #0b1220 !important;
}

/* وضع داكن: لون مسطح مطابق لصناديق الوضع الداكن */
body.dark-mode .footer-icons{
  background: #0f265a !important;   /* بديل للتدرّج الداكن */
  border-color: #334155;
  box-shadow: 0 8px 22px rgba(0,0,0,0.35);
}

/* نص العنوان في الوضع الداكن */
body.dark-mode .footer-title{
  color: #e6edf3 !important;
}
  </style> </head>
 <body>
  <div id="headerContainer"></div>
  <div id="sidebarContainer"></div>

  <div id="preloader">
  <div class="loader"></div>
</div>



  <!-- Toast -->
  <div id="toast" style="
    visibility: hidden;
    min-width: 250px;
    margin-left: -125px;
    background-color: #323232;
    color: #fff;
    text-align: center;
    border-radius: 12px;
    padding: 16px;
    position: fixed;
    z-index: 9999;
    left: 50%;
    bottom: 30px;
    font-size: 16px;
    box-shadow: 0px 2px 10px rgba(0,0,0,0.2);
    transition: visibility 0s, opacity 0.5s ease-in-out;
    opacity: 0;">
    <span id="toast-message"></span>
  </div>

  <form id="orderForm" novalidate>
    <div class="container">

      <div id="top-banner">
        <div class="banner-layer" id="banner1"></div>
        <div class="banner-layer" id="banner2"></div>
      </div>

<div class="player-id-box" style="
  max-width: 500px; margin: 20px auto; padding: 20px;
  border: 2px solid #007bff; border-radius: 10px; background-color: #f9f9f9;">
  
  <label for="player-id" style="font-size:16px; font-weight:bold; margin-bottom:10px; display:block;">
    معرف اللاعب 🎮
    <i onclick="openPopup()" style="color:#007bff; cursor: pointer;" title="معرف اللاعب داخل اللعبة"></i>
  </label>
  
  <div class="input-group" style="display:flex;">
    <input id="player-id" placeholder="أدخل معرف اللاعب هنا"
           style="flex:1; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:8px 0 0 8px;" type="text" />
  </div>

  <!-- الملاحظة أسفل حقل الإدخال -->
  <p style="margin-top:8px; font-size:14px; color:#d9534f; font-weight:bold;">
  </p>
</div>


      <!-- النافذة المنبثقة -->
      <div id="popup" onclick="closePopupOnOutsideClick(event)"
           style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
        <div onclick="event.stopPropagation()" style="position:relative; background:white; padding:10px; border-radius:10px; max-width:90%; max-height:90%;">
          <span onclick="closePopup()" style="position:absolute; top:5px; right:10px; font-size:32px; color:red; cursor:pointer;">×</span>
          <img alt="معلومات" src="https://i.ibb.co/Xr0rms0C/ff.webp" style="max-width:100%; max-height:80vh; display:block; margin:auto;"/>
        </div>
      </div>

      
        <div id="myOffersContainer"></div>

        <div id="selected-amount-container" style="
          margin:20px auto; max-width:400px; padding:20px; text-align:center;
          border:2px solid #007bff; border-radius:10px; background-color:#f9f9f9; font-weight:bold;">
          <h2> المبلغ المطلوب : </h2>
          <div class="voucher"><span id="selected-amount">لم يتم اختيار عرض شحن</span></div>
        </div>

        <!-- ✅ Turnstile -->
        <div class="cf-turnstile" data-sitekey="0x4AAAAAABuMTLzhZ91H8VE1" data-theme="light"></div>

        <button class="send-button" style="margin-top:20px; padding:10px 20px; font-size:18px; background:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer;" type="submit">شراء</button>
      </div>
    </div>

    <div style="height: 40px;"></div>
    <div id="footerContainer"></div>
  </form>

  <script>

    (function(){
  try{
    var saved = localStorage.getItem('theme');
    if(saved === 'dark'){
      document.body.classList.add('dark-mode');
      // لو رغبت فرض Turnstile داكنًا دومًا:
      var t = document.querySelector('.cf-turnstile');
      if(t) t.setAttribute('data-theme','dark');
    }
  }catch(e){}
})();
  // ===== Footer =====
  const footer = document.createElement("footer");
  footer.className = "footer-icons";
  const footerTitle = document.createElement("h2");
  footerTitle.className = "footer-title";
  footerTitle.textContent = "لماذا تختارنا؟";
  footer.appendChild(footerTitle);
  const iconBoxesData = [
    { iconClass: "fas fa-shipping-fast shipping-icon", title: "شحن سريع", desc: "يتميز متجرنا بسرعته الفائقة بالشحن فبمجرد أن تطلب سيتم الشحن لك مباشرة" },
    { iconClass: "fas fa-lock", title: "آمن 100%", desc: "حماية كاملة للبيانات والمعاملات" },
    { iconClass: "fas fa-headset", title: "دعم فني مستمر", desc: "دعم فني مستمر لمساعدة العملاء عند الحاجة" },
    { iconClass: "fas fa-coins special-icon", title: "اسعار مميزة", desc: "نقدم اسعار اقل من اسعار اللعبة" },
    { iconClass: "fas fa-credit-card", title: "سهولة الدفع", desc: "طرق دفع عديدة" },
    { iconClass: "fas fa-shield-alt", title: "ضمان على الشحن", desc: "احصل على كامل المبلغ مع تعويض في حالة عدم وصول الشحنه" },
    { iconClass: "fas fa-sync-alt", title: "تحديثات مستمرة", desc: "نقوم بحل جميع المشاكل بشكل دوري" },
    { iconClass: "fas fa-tasks", title: "تعقب الطلبات", desc: "يمكنك رؤية حالة الطلبات الخاص بك من تبويب طلباتي" },
    { iconClass: "fas fa-undo", title: "الغاء الطلبات", desc: "يمكنك الغاء اي طلب قبل اتمام عملية الدفع عبر التواصل مع الدعم الفني" },
    { iconClass: "fas fa-server", title: "تخزين للطلبات", desc: "يتم وضع الطلبات في سيرفرات لعدم فقدانها تحت اي ضرف" }
  ];
  iconBoxesData.forEach(({ iconClass, title, desc }) => {
    const box = document.createElement("div");
    box.className = "icon-box";
    const icon = document.createElement("i"); icon.className = iconClass; box.appendChild(icon);
    const h3 = document.createElement("h3"); h3.textContent = title; box.appendChild(h3);
    const p = document.createElement("p"); p.textContent = desc; box.appendChild(p);
    footer.appendChild(box);
  });

  // ===== بطاقات العروض =====
  function createOfferBox({ type, jewels, offer, imgSrc, imgAlt }) {
    const div = document.createElement("div");
    div.className = "offer-box";
    div.dataset.type = type;
    if (jewels) div.dataset.jewels = jewels;
    if (offer) div.dataset.offer = offer;
    div.onclick = function () { toggleOffer(this); };
    const img = document.createElement("img");
    img.src = imgSrc; img.alt = imgAlt;
    img.loading = 'lazy'; img.decoding = 'async'; img.setAttribute('fetchpriority','low');
    div.appendChild(img);
    const span = document.createElement("span"); span.textContent = jewels ? `${jewels} جوهرة` : offer; div.appendChild(span);
    return div;
  }

  const offersBox = document.createElement("div"); offersBox.className = "offers-box";
  const label = document.createElement("label"); label.textContent = "اختر عرض الشحن 🎁"; offersBox.appendChild(label);
  const topupOffers = [
    { jewels: 110, imgSrc: "https://i.ibb.co/m5HLhf1n/1756802404151-1.jpg", imgAlt: "620" },
    { jewels: 210, imgSrc: "https://i.ibb.co/m5HLhf1n/1756802404151-1.jpg", imgAlt: "340 توكنز" },
    { jewels: 583, imgSrc: "https://i.ibb.co/m5HLhf1n/1756802404151-1.jpg", imgAlt: "570 توكنز" },
    { jewels: 1188, imgSrc: "https://i.ibb.co/m5HLhf1n/1756802404151-1.jpg", imgAlt: "1024 توكنز" },
    { jewels: 2420, imgSrc: "https://i.ibb.co/m5HLhf1n/1756802404151-1.jpg", imgAlt: "20000 توكنز" }
  ];
  topupOffers.forEach(offer => { offersBox.appendChild(createOfferBox({ type: "topup", jewels: offer.jewels, imgSrc: offer.imgSrc, imgAlt: offer.imgAlt })); });
  const membershipOffersGrid = document.createElement("div"); membershipOffersGrid.id = "membership-offers"; membershipOffersGrid.className = "offers-grid"; membershipOffersGrid.style.justifyContent = "center";
  const membershipOffers = [

  ];
  membershipOffers.forEach(offer => { membershipOffersGrid.appendChild(createOfferBox({ type: "membership", offer: offer.offer, imgSrc: offer.imgSrc, imgAlt: offer.imgAlt })); });
  offersBox.appendChild(membershipOffersGrid);

  window.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById("myOffersContainer");
    if (container) container.appendChild(offersBox);
    // ✅ اربط الفورم بـ sendOrder ومنع إعادة التحميل
    const form = document.getElementById('orderForm');
    if (form) {
      form.addEventListener('submit', function(e){
        e.preventDefault();
        if (typeof sendOrder === 'function') sendOrder();
      });
    }
  });

  // ===== حساب السعر وعرضه =====
function toggleOffer(element) {
  if (element.classList.contains("disabled")) { 
    showToast("غير متوفر", "warning"); 
    return; 
  }

  // ✅ إلغاء تحديد جميع العروض الأخرى
  document.querySelectorAll('.offer-box.selected').forEach(el => {
    el.classList.remove('selected');
  });

  // ✅ تحديد العنصر الحالي فقط
  element.classList.add("selected");

  const selectedOffers = [{
    type: element.dataset.type,
    jewels: element.dataset.jewels || null,
    offerName: element.dataset.offer || null
  }];

  // ✅ قراءة الأسعار من localStorage
  const raw = JSON.parse(localStorage.getItem("offersPrices") || "{}");
  const offersPrices = raw.prices || raw;

  let total = 0; 
  const breakdownLines = [];
  const key = element.dataset.jewels ? `${element.dataset.jewels}_jewels` : element.dataset.offer;
  const price = offersPrices[key];
  if (price !== undefined) {
    total += Number(price);
const nameText  = element.dataset.jewels ? `${element.dataset.jewels} جوهرة` : element.dataset.offer;
const priceText = `${Number(price).toFixed(2)} د.أ`;
breakdownLines.push(
  `<span class="item-name">${nameText}</span> : <span class="item-price">${priceText}</span>`
);

  } else {
    breakdownLines.push(`• ${element.dataset.jewels || element.dataset.offer}: ❓ غير معروف`);
  }

const el = document.getElementById("selected-amount");

if (breakdownLines.length === 0) {
  // لا يوجد أي عنصر مختار
  el.textContent = "لم يتم اختيار عرض شحن";
  el.classList.add("no-selection");
} else 
  // يوجد عناصر مختارة
  el.innerHTML = `${breakdownLines.join("<br>")}<br><br><strong>المجموع: ${total.toFixed(2)} د.أ</strong>`;
  el.classList.remove("no-selection");
}



  // ===== Toast =====
  function showToast(message, type = "info", duration = 4000) {
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toast-message");
    if (!toast || !toastMessage) return;
    let icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
    toastMessage.innerHTML = `<span style="margin-right:8px;">${icon}</span>${message}`;
    toast.style.background = type === 'success' ? 'linear-gradient(135deg, #28a745, #218838)'
                          : type === 'error'   ? 'linear-gradient(135deg, #dc3545, #b52a38)'
                          : type === 'warning' ? 'linear-gradient(135deg, #ffc107, #e0a800)'
                                               : 'linear-gradient(135deg, #17a2b8, #117a8b)';
    toast.style.color = '#fff'; toast.style.padding = '14px 20px'; toast.style.borderRadius = '10px';
    toast.style.fontSize = '16px'; toast.style.fontWeight = 'bold'; toast.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
    toast.style.display = 'flex'; toast.style.alignItems = 'center'; toast.style.gap = '10px';
    toast.style.transform = 'translateY(100px)'; toast.style.opacity = '0'; toast.style.visibility = 'visible'; toast.style.transition = 'all 0.5s ease';
    setTimeout(() => { toast.style.transform = 'translateY(0)'; toast.style.opacity = '1'; }, 50);
    setTimeout(() => { toast.style.transform = 'translateY(100px)'; toast.style.opacity = '0'; setTimeout(() => { toast.style.visibility = 'hidden'; }, 500); }, duration);
  }

  // ===== تهيئة بطاقات التفعيل/التعطيل من Firestore =====
  firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
      const userDocRef = firebase.firestore().collection("users").doc(user.uid);
      const snap = await userDocRef.get();
      if (snap.exists) {
        const userData = snap.data();
        const nameInput = document.getElementById("userName");
        if (nameInput) {
          nameInput.value = userData.username || "";
          nameInput.readOnly = true;
          nameInput.style.backgroundColor = "#e9ecef";
          nameInput.style.cursor = "not-allowed";
        }
      }
    } else {
      location.href = "main.html";
    }
  });

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const stateDoc = await firebase.firestore().collection("freefireauto").doc("state").get();
      if (stateDoc.exists) {
        const stateData = stateDoc.data();
        Object.entries(stateData.topup || {}).forEach(([jewels, status]) => {
          const card = document.querySelector(`.offer-box[data-type="topup"][data-jewels="${jewels}"]`);
          if (card) { card.classList.toggle('disabled', status === 'off'); card.style.opacity = status === 'off' ? '0.4' : '1'; }
        });
        Object.entries(stateData.membership || {}).forEach(([offerName, status]) => {
          const card = document.querySelector(`.offer-box[data-type="membership"][data-offer="${offerName}"]`);
          if (card) { card.classList.toggle('disabled', status === 'off'); card.style.opacity = status === 'off' ? '0.4' : '1'; }
        });
      } else {
        console.warn("⚠️ لم يتم العثور على وثيقة الحالة في Firestore");
      }
    } catch (e) { console.error("❌ فشل في جلب حالة العروض:", e); }
  });
  </script>
 </body>
</html>
