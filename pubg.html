<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Ù…ØªØ¬Ø± Ù‚ØµÙŠ - Ø¨Ø¨Ø¬ÙŠ</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <!-- Ø£ÙƒÙˆØ§Ø¯Ùƒ -->
  <script defer src="script1pubg.js"></script>
  <script defer src="state.js"></script>
  <script defer src="header.js"></script>
  <script defer src="atff.js"></script>
  <script defer src="scriptpubg.js"></script>

  <!-- Ø®Ø·ÙˆØ· ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

  <!-- Ø§Ù†ØªØ¨Ù‡: ÙƒØ§Ù†Øª Ù‡Ù†Ø§ Ù…Ø­Ø§Ø±Ù Ù…Ø®ÙÙŠØ© Ù‚Ø¨Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù -->
  <link href="style1.css" rel="stylesheet"/>
  <link href="header.css" rel="stylesheet"/>
  <link rel="stylesheet" href="loader.css">
<script src="loader.js" defer></script>


  <audio id="toast-success-sound" preload="auto" src="success.mp3"></audio>
  <audio id="toast-error-sound" preload="auto" src="error.mp3"></audio>

  <style>
    /* Ø§ØªØ¬Ø§Ù‡ Ø¹Ø§Ù… Ù…Ø³Ø§Ø¹Ø¯ */
    .rtl { direction: rtl; text-align: right; unicode-bidi: embed; }


    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ù„Ø®Øµ */
    #selected-amount-container {
      display: flex !important;
      flex-direction: column !important;
      align-items: center !important;
      text-align: center !important;
      margin:20px auto;max-width:400px;padding:20px;
      border:2px solid #007bff;border-radius:10px;background:#f9f9f9;font-weight:bold;
    }
    #selected-amount-container h2 { margin-bottom: 10px !important; }

    /* âœ… Ø§Ù„Ù‚Ø³ÙŠÙ…Ø© RTL Ù…Ø¹ Ø¹Ø²Ù„ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© */
    #selected-amount-container .voucher{
      display:block !important;
      margin:0 auto !important;
      direction: rtl;
      text-align: right;
      unicode-bidi: isolate;
      font-weight: 700;
    }
    .voucher .line{ direction: rtl; text-align: right; margin: 10px 0; }
    .voucher .ltr{ direction: ltr; unicode-bidi: isolate; display:inline-block; white-space: nowrap; }
    .voucher .sep{ unicode-bidi: isolate; display:inline-block; padding: 0 .15rem; }
    .voucher .price{ white-space: nowrap; }

    /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª + ØªØºØ·ÙŠØ© "ØºÙŠØ± Ù…ØªÙˆÙØ±" */
    .offer-box { position: relative; cursor: pointer; }
    .offer-box.disabled { opacity: .4; cursor: not-allowed; }
    .offer-box .unavailable-badge{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35); color:#fff; font-weight:700; border-radius:12px;
    }
  </style>
</head>
<body>
  <div id="headerContainer"></div>
  <div id="sidebarContainer"></div>

  <div id="preloader">
  <div class="loader"></div>
</div>


  <!-- Toast -->
  <div id="toast" style="
    visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #323232;
    color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed;
    z-index: 9999; left: 50%; bottom: 30px; font-size: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.2);
    transition: visibility 0s, opacity .5s ease-in-out; opacity: 0;">
    <span id="toast-message"></span>
  </div>

  <form id="orderForm" novalidate>
    <div class="container">
      <div id="top-banner">
        <div class="banner-layer" id="banner1"></div>
        <div class="banner-layer" id="banner2"></div>
      </div>

      <div class="player-id-box" style="max-width:500px;margin:20px auto;padding:20px;border:2px solid #007bff;border-radius:10px;background:#f9f9f9;">
        <label for="player-id" style="font-size:16px;font-weight:bold;margin-bottom:10px;display:block;">
          Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ ğŸ®
          <i onclick="openPopup()" style="color:#007bff;cursor:pointer;" title="Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©">â“</i>
        </label>
        <div class="input-group" style="display:flex;">
          <input id="player-id" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‡Ù†Ø§"
                 style="flex:1;padding:12px;font-size:16px;border:1px solid #ccc;border-radius:8px 0 0 8px;" type="text" />
        </div>
      </div>

      <!-- Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
      <div id="popup" onclick="closePopupOnOutsideClick(event)"
           style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:9999;justify-content:center;align-items:center;">
        <div onclick="event.stopPropagation()" style="position:relative;background:white;padding:10px;border-radius:10px;max-width:90%;max-height:90%;">
          <span onclick="closePopup()" style="position:absolute;top:5px;right:10px;font-size:32px;color:red;cursor:pointer;">Ã—</span>
          <img alt="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª" src="https://i.ibb.co/Xr0rms0C/ff.webp" style="max-width:100%;max-height:80vh;display:block;margin:auto;"/>
        </div>
      </div>

      <div class="main-white-box">
        <div id="myOffersContainer"></div>

        <div id="selected-amount-container">
          <h2>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ :</h2>
          <div class="voucher"><span id="selected-amount">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ø´Ø­Ù†</span></div>
        </div>

        <!-- âœ… Turnstile -->
        <div class="cf-turnstile" data-sitekey="0x4AAAAAABruWuZyj0lgHNVc" data-theme="light"></div>

        <button class="send-button" style="margin-top:20px;padding:10px 20px;font-size:18px;background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer;" type="submit">Ø´Ø±Ø§Ø¡</button>
      </div>
    </div>

    <div style="height:40px;"></div>
    <div id="footerContainer"></div>
  </form>

  <script>
    // ===== Footer =====
    const footer = document.createElement("footer");
    footer.className = "footer-icons";
    const footerTitle = document.createElement("h2");
    footerTitle.className = "footer-title";
    footerTitle.textContent = "Ù„Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø±Ù†Ø§ØŸ";
    footer.appendChild(footerTitle);
    [
      { iconClass: "fas fa-shipping-fast shipping-icon", title: "Ø´Ø­Ù† Ø³Ø±ÙŠØ¹", desc: "ÙŠØªÙ…ÙŠØ² Ù…ØªØ¬Ø±Ù†Ø§ Ø¨Ø³Ø±Ø¹ØªÙ‡ Ø§Ù„ÙØ§Ø¦Ù‚Ø© Ø¨Ø§Ù„Ø´Ø­Ù† ÙØ¨Ù…Ø¬Ø±Ø¯ Ø£Ù† ØªØ·Ù„Ø¨ Ø³ÙŠØªÙ… Ø§Ù„Ø´Ø­Ù† Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©" },
      { iconClass: "fas fa-lock", title: "Ø¢Ù…Ù† 100%", desc: "Ø­Ù…Ø§ÙŠØ© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª" },
      { iconClass: "fas fa-headset", title: "Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…Ø³ØªÙ…Ø±", desc: "Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…Ø³ØªÙ…Ø± Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©" },
      { iconClass: "fas fa-coins special-icon", title: "Ø§Ø³Ø¹Ø§Ø± Ù…Ù…ÙŠØ²Ø©", desc: "Ù†Ù‚Ø¯Ù… Ø§Ø³Ø¹Ø§Ø± Ø§Ù‚Ù„ Ù…Ù† Ø§Ø³Ø¹Ø§Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©" },
      { iconClass: "fas fa-credit-card", title: "Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¯ÙØ¹", desc: "Ø·Ø±Ù‚ Ø¯ÙØ¹ Ø¹Ø¯ÙŠØ¯Ø©" },
      { iconClass: "fas fa-shield-alt", title: "Ø¶Ù…Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø­Ù†", desc: "Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø¹ ØªØ¹ÙˆÙŠØ¶ ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØµÙˆÙ„ Ø§Ù„Ø´Ø­Ù†Ù‡" },
      { iconClass: "fas fa-sync-alt", title: "ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ø³ØªÙ…Ø±Ø©", desc: "Ù†Ù‚ÙˆÙ… Ø¨Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ" },
      { iconClass: "fas fa-tasks", title: "ØªØ¹Ù‚Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª", desc: "ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¤ÙŠØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø·Ù„Ø¨Ø§ØªÙŠ" },
      { iconClass: "fas fa-undo", title: "Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª", desc: "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØºØ§Ø¡ Ø§ÙŠ Ø·Ù„Ø¨ Ù‚Ø¨Ù„ Ø§ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ" },
      { iconClass: "fas fa-server", title: "ØªØ®Ø²ÙŠÙ† Ù„Ù„Ø·Ù„Ø¨Ø§Øª", desc: "ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø³ÙŠØ±ÙØ±Ø§Øª Ù„Ø¹Ø¯Ù… ÙÙ‚Ø¯Ø§Ù†Ù‡Ø§ ØªØ­Øª Ø§ÙŠ Ø¶Ø±Ù" }
    ].forEach(({ iconClass, title, desc }) => {
      const box = document.createElement("div");
      box.className = "icon-box";
      const icon = document.createElement("i"); icon.className = iconClass; box.appendChild(icon);
      const h3 = document.createElement("h3"); h3.textContent = title; box.appendChild(h3);
      const p = document.createElement("p"); p.textContent = desc; box.appendChild(p);
      footer.appendChild(box);
    });
    document.getElementById("footerContainer").appendChild(footer);

    // ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ø±ÙˆØ¶ =====
    function createOfferBox({ type, uc, offer, imgSrc, imgAlt }) {
      const div = document.createElement("div");
      div.className = "offer-box";
      div.dataset.type = type;
      if (uc) div.dataset.uc = uc;
      if (offer) div.dataset.offer = offer;
      div.onclick = function(){ toggleOffer(this); };
      const img = document.createElement("img"); img.src = imgSrc; img.alt = imgAlt; div.appendChild(img);
      const span = document.createElement("span"); span.textContent = uc ? `${uc} uc` : offer; div.appendChild(span);
      return div;
    }

    const offersBox = document.createElement("div"); offersBox.className = "offers-box";
    const label = document.createElement("label"); label.textContent = "Ø§Ø®ØªØ± Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø­Ù† ğŸ"; offersBox.appendChild(label);

    const topupOffers = [
      { uc: 60,   imgSrc: "https://cdn.midasbuy.com/images/apps/pubgm/1599546071746KqkIhrzG.png", imgAlt: "60 uc"   },
      { uc: 120,  imgSrc: "https://cdn.midasbuy.com/images/apps/pubgm/1599546071746KqkIhrzG.png", imgAlt: "120 uc"  },
      { uc: 325,  imgSrc: "https://cdn.midasbuy.com/images/apps/pubgm/1599546071746KqkIhrzG.png", imgAlt: "325 uc"  },
      { uc: 660,  imgSrc: "https://cdn.midasbuy.com/images/apps/pubgm/1599546071746KqkIhrzG.png", imgAlt: "660 uc"  },
      { uc: 1800, imgSrc: "https://cdn.midasbuy.com/images/apps/pubgm/1599546071746KqkIhrzG.png", imgAlt: "1800 uc" },
      { uc: 3850, imgSrc: "https://cdn.midasbuy.com/images/apps/pubgm/1599546071746KqkIhrzG.png", imgAlt: "3850 uc" },
      { uc: 8100, imgSrc: "https://cdn.midasbuy.com/images/apps/pubgm/1599546071746KqkIhrzG.png", imgAlt: "8100 uc" }
    ];
    topupOffers.forEach(o => offersBox.appendChild(createOfferBox({ type:"topup", uc:o.uc, imgSrc:o.imgSrc, imgAlt:o.imgAlt })));

    const membershipTitle = document.createElement("div"); membershipTitle.className = "section-title"; membershipTitle.textContent = "Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª"; offersBox.appendChild(membershipTitle);
    const membershipOffersGrid = document.createElement("div"); membershipOffersGrid.id = "membership-offers"; membershipOffersGrid.className = "offers-grid"; membershipOffersGrid.style.justifyContent = "center";
    [
      { offer: "ELITE PASS 1 - 100", imgSrc: "https://cdn.midasbuy.com/images/elite_1520x770%20.a86bc11a.jpg", imgAlt: "ELITE PASS 1 - 100" },
      { offer: "ELITE PASS 1 - 50",  imgSrc: "https://cdn.midasbuy.com/images/tiyan_1520x770.f467ea1c.jpg",     imgAlt: "ELITE PASS 1 - 50"  }
    ].forEach(o => membershipOffersGrid.appendChild(createOfferBox({ type:"membership", offer:o.offer, imgSrc:o.imgSrc, imgAlt:o.imgAlt })));
    offersBox.appendChild(membershipOffersGrid);

    window.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById("myOffersContainer");
      if (container) container.appendChild(offersBox);

      // Ø§Ø±Ø¨Ø· Ø§Ù„ÙÙˆØ±Ù… Ø¨Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¥Ù† ÙˆÙØ¬Ø¯Øª sendOrder ÙÙŠ scriptpubg.js)
      const form = document.getElementById('orderForm');
      if (form) {
        form.addEventListener('submit', function(e){
          e.preventDefault();
          if (typeof sendOrder === 'function') sendOrder();
        });
      }
    });

    // ===== Ø£Ø¯ÙˆØ§Øª Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø·ÙˆØ± RTL Ù…Ø¹ Ø¹Ø²Ù„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© =====
    function lineHtmlUC(amount, price) {
      return `
        <div class="line">
          <span class="ltr">${amount} UC</span>
          <span class="sep">:</span>
          <span class="price">${Number(price).toFixed(2)} Ø¯.Ø£</span>
        </div>`;
    }
    function lineHtmlMembership(name, price) {
      return `
        <div class="line">
          <span class="ltr">${escapeHtml(name)}</span>
          <span class="sep">:</span>
          <span class="price">${Number(price).toFixed(2)} Ø¯.Ø£</span>
        </div>`;
    }
    function totalHtml(total){
      return `
        <div class="line">
          <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</span>
          <span class="price">${Number(total).toFixed(2)} Ø¯.Ø£</span>
        </div>`;
    }
    function escapeHtml(s){
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    // ===== Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®ØªØ§Ø± =====
    function toggleOffer(element){
      if (element.classList.contains("disabled")) { showToast("ØºÙŠØ± Ù…ØªÙˆÙØ±", "warning"); return; }
      document.querySelectorAll('.offer-box.selected').forEach(el => el.classList.remove('selected'));
      element.classList.add("selected");

  const raw = JSON.parse(localStorage.getItem("offersPrices") || "{}");
  const offersPrices = raw.prices || raw;

  let total = 0; 
  const breakdownLines = [];
  const key = element.dataset.uc ? `${element.dataset.uc}_uc` : element.dataset.offer;
  const price = offersPrices[key];
  if (price !== undefined) {
    total += Number(price);
const nameText  = element.dataset.uc ? `${element.dataset.uc} uc` : element.dataset.offer;
const priceText = `${Number(price).toFixed(2)} Ø¯.Ø£`;
breakdownLines.push(
  `<span class="item-name">${nameText}</span> : <span class="item-price">${priceText}</span>`
);

  } else {
    breakdownLines.push(`â€¢ ${element.dataset.uc || element.dataset.offer}: â“ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ`);
  }

const el = document.getElementById("selected-amount");

if (breakdownLines.length === 0) {
  // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø¹Ù†ØµØ± Ù…Ø®ØªØ§Ø±
  el.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø±Ø¶ Ø´Ø­Ù†";
  el.classList.add("no-selection");
} else 
  // ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø®ØªØ§Ø±Ø©
  el.innerHTML = `${breakdownLines.join("<br>")}<br><br><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total.toFixed(2)} Ø¯.Ø£</strong>`;
  el.classList.remove("no-selection");
}

    // ===== Toast =====
    function showToast(message, type="info", duration=3000){
      const toast = document.getElementById("toast");
      const msg = document.getElementById("toast-message");
      if (!toast || !msg) return;
      const icon = type==='success'?'âœ…':type==='error'?'âŒ':type==='warning'?'âš ï¸':'â„¹ï¸';
      msg.innerHTML = `<span style="margin-right:8px;">${icon}</span>${message}`;
      toast.style.background = type==='success'?'#28a745':type==='error'?'#dc3545':type==='warning'?'#ffc107':'#17a2b8';
      toast.style.visibility='visible'; toast.style.opacity='1';
      setTimeout(()=>{ toast.style.opacity='0'; setTimeout(()=>toast.style.visibility='hidden',500); }, duration);
    }

    /* ===== util: ØªØ­Ø¯ÙŠØ¯ â€œØ§Ù„Ø¥ØºÙ„Ø§Ù‚â€ Ø¨Ø¹Ø¯Ø© Ù‚ÙŠÙ… Ù†ØµÙŠØ© ===== */
const isOffText = (status) => String(status ?? "").trim().toLowerCase() === 'off';
const normalizeUCKey = (key) => {
  const m = String(key ?? "").match(/\d+/);
  return m ? String(Number(m[0])) : "";
};
function addUnavailableOverlay(card){
  let badge = card.querySelector(".unavailable-badge");
  if (!badge) {
    badge = document.createElement("div");
    badge.className = "unavailable-badge";
    badge.textContent = "ØºÙŠØ± Ù…ØªÙˆÙØ±";
    card.appendChild(badge);
  }
}

let unsubscribeState = null;

window.addEventListener('DOMContentLoaded', () => {
  const db = firebase.firestore();
  unsubscribeState = db.collection("topup").doc("pubg").onSnapshot((snap) => {
    if (!snap.exists) return;

    let stateRaw = (snap.data() || {}).state;
    let parsed = null;
    if (typeof stateRaw === 'string') {
      try { parsed = JSON.parse(stateRaw); } catch(e){ return; }
    } else if (stateRaw && typeof stateRaw === 'object') {
      parsed = stateRaw;
    } else { return; }

    const topupMap = parsed.topup || {};
    const membershipMap = parsed.membership || parsed.memberships || {};

    Object.entries(topupMap).forEach(([ucKeyRaw, status]) => {
      const ucNormalized = normalizeUCKey(ucKeyRaw);
      const card = document.querySelector(`.offer-box[data-type="topup"][data-uc="${ucNormalized}"]`);
      if (card) {
        const off = isOffText(status);
        card.classList.toggle('disabled', off);
        card.style.opacity = off ? '0.4' : '1';
        if (off) addUnavailableOverlay(card); else { const b = card.querySelector(".unavailable-badge"); if (b) b.remove(); }
      }
    });

    Object.entries(membershipMap).forEach(([offerName, status]) => {
      const card = document.querySelector(`.offer-box[data-type="membership"][data-offer="${offerName}"]`);
      if (card) {
        const off = isOffText(status);
        card.classList.toggle('disabled', off);
        card.style.opacity = off ? '0.4' : '1';
        if (off) addUnavailableOverlay(card); else { const b = card.querySelector(".unavailable-badge"); if (b) b.remove(); }
      }
    });
  });
});

window.addEventListener('beforeunload', () => {
  if (typeof unsubscribeState === 'function') unsubscribeState();
});
  </script>
</body>
</html>
